# Содержание:

---
## Модуль `Auth`

---

### Структуры:

---
- [Структуры модели User](#user-structure)

---
### Варианты использования:

---
- [Регистрация в админку c подтверждением email](#sign-up-to-admin)
- [Аутентификация в админку](#sign-in-to-admin)
- [Запрос на сброс пароля в админку](#access-recovery-to-admin)
- [Обновление пароля](#password-udate-to-admin)
- [Запрос на обновление email. Обновление email](#email-udate-to-admin)


---
## Модуль `Blog`

---

### Структуры:

---
- [Структуры модели Reader](#reader-structure)
- [Структуры модели Post](#post-structure)
- [Структуры модели Category](#post-category-structure)
- [Структуры модели Comment](#post-comment-structure)
- [Структуры модели Tag](#post-tag-structure)

---
### Варианты использования:

---
- [Создание читателя блога](#create-blog-reader)

<br>
<br>
<br>

### Структуры модели User <a name="user-structure"></a>

`User`

|    Название колонки    |     Тип      | nullable |             Назначение              |
|:----------------------:|:------------:|:--------:|:-----------------------------------:|
|           id           |     UUID     |   нет    |     Идентификатор пользователя      |
|       first_name       | varchar(255) |   нет    |                 Имя                 |
|       last_name        | varchar(255) |    да    |               Фамилия               |
|         email          | varchar(255) |   нет    |                Почта                |
|  email_confirm_token   | varchar(255) |    да    |   Подтвержение корректности email   |
|         status         | varchar(255) |   нет    |         Статус пользователя         |
|          role          | varchar(255) |   нет    |          Роль пользователя          |
|     password_hash      | varchar(255) |   нет    |             Хэш пароля              |
|          host          | varchar(100) |    да    |     Хост-источник пользователя      |
|  reset_password_token  | varchar(255) |    да    |         Токен сброса пароля         |
| password_token_expires |  timestamp   |    да    | Время действия токена сброса пароля |
|       new_email        | varchar(255) |    да    |             Новый email             |
|       created_at       |  timestamp   |   нет    |            Дата создания            |



### Регистрация в админку c подтверждением email <a name="sign-up-to-admin"></a>

**Бизнес смысл**

Регистрация представляет собой страницу sign page для входа в систему. Данная страница состоит из формы регистрации пользования со следующими полями: имя, email, пароль

**Входные данные**

|   Название поля    | Обязательность |             Примечание              |
|:------------------:|:--------------:|:-----------------------------------:|
|     firstName      |       да       | Валидация текста (min/max и прочее) |
|       email        |       да       |           Валидация email           |
|      password      |       да       |          Валидация пароля           |
| registrationSource |       да       |        Источник регистрации         |

**Логика обработки данных из формы**

1. Создать пользователя со статусом wait и с ролью ROLE_USER и проверкой возможных инвариантов. При создании пользователя формируется доменное событие UserCreatedEvent со следующими полями:  
    <br>
    - id
    - firstName
    - lastName
    - email
    - emailConfirmToken
    - status
    - role
    - registrationSource
    - createdAt  
    <br>  
2. Создать слушатель события UserCreatedEvent который отправит пользователю на указанный email письмо с подтверждением аккаунта (email), где в качестве query string будет указан email_confirm_token и id пользователя.  
<br>
   - Ссылка подтверждения email пользователя формируется с учетом содержимого registrationSource. На текущий момент registrationSource может принимать два значения - blog, shop, которым в модуле Auth соответствуют реальные доменные имена (domain) заданные через переменные окружения (.env...). В результате ссылка для регистрации формируется следующим образом н-р - **https:/<domain>/confirm-email?userId=<id>&token=<token>**  
<br>
3. При переходе по ссылке из письма статус пользователя меняет статус на active. Поле email_confirm_token обнуляется. С этого момента система считает пользователя авторизованным.
4. После добавления пользователя бросается событие 

`*email_confirm_token - можно получить с использованием UUID`  
`*возможные статусы пользователя: blocked, active, wait`  
`*возможные роли пользователя: ROLE_USER, ROLE_ADMIN`  



### Аутентификация в админку<a name="sign-in-to-admin"></a>

**Бизнес смысл**

Представляет собой страницу для процедуры проверки подлинности пользователя

**Входные данные**

| Название поля | Обязательность |             Примечание              |
|:-------------:|:--------------:|:-----------------------------------:|
|     email     |       да       |           Валидация email           |
|   password    |       да       |          Валидация пароля           |

**Логика обработки данных из формы**

1. Настроить security bundle для входа пользователя в админку с сохранением ID сессии в cookie заголовках
2. После аутентификации пользователь должен попасть в админку сервиса



### Запрос на сброс пароля в админку<a name="access-recovery-to-admin"></a>

**Бизнес смысл**

Процесс обновления пароля в системе

**Входные данные**

| Название поля | Обязательность |             Примечание              |
|:-------------:|:--------------:|:-----------------------------------:|
|     email     |       да       |           Валидация email           |

**Логика обработки данных из формы**

1. Заполняем поля reset_password_token (UUID) и password_token_expires.
2. Отправляем пользователю письмо содержащее ссылку на страницу для сброса пароля. Ссылка содержит в query string reset_password_token который "разрешает" данному пользователю сбросить пароль



### Обновление пароля<a name="password-udate-to-admin"></a>

**Бизнес смысл**

Страница обновления пароля

**Входные данные**

|     Название поля      | Обязательность |    Примечание     |
|:----------------------:|:--------------:|:-----------------:|
|  reset_password_token  |       да       |  из query string  |
|        password        |       да       | Валидация пароля  |

**Логика обработки данных из формы**

1. Проверяем соответствует ли reset_password_token тому что в бд, если да переходим далее.
2. Проверяем поле password_token_expires, если password_token_expires < now(), то необходимо бросить исключение - "Срок действия токена для сброса пароля истек, повторите операцию". Обнуляем поля reset_password_token и password_token_expires
3. Обновляем пароль пользователя и через всплывашку указываем пользователю сообщение о том, что операция прошла успешно
4. Перенаправляем пользователя на страницу входа в систему



### Запрос на обновление email. Обновление email<a name="password-udate-to-admin"></a>

`*На данный момент это не является приоритетным функционалом, будет добавлен позднее`



### Структуры модели Reader <a name="reader-structure"></a>

`Reader`

|    Название колонки    |     Тип      | nullable |       Назначение       |
|:----------------------:|:------------:|:--------:|:----------------------:|
|           id           |     UUID     |   нет    | Идентификатор читателя |
|       first_name       | varchar(255) |   нет    |          Имя           |
|       last_name        | varchar(255) |    да    |        Фамилия         |
|         email          | varchar(255) |   нет    |         Почта          |
|       created_at       |  timestampz  |   нет    |     Дата создания      |



### Создание читателя блога <a name="create-blog-reader"></a>

**Бизнес смысл**

На первом этапе читатель блога создается с целью возможности комментировании статей блога

**Входные данные**

| Название поля | Обязательность |             Примечание              |
|:-------------:|:--------------:|:-----------------------------------:|
|   firstName   |       да       | Валидация текста (min/max и прочее) |
|   last_name   |       да       | Валидация текста (min/max и прочее) |
|     email     |       да       |           Валидация email           |

**Логика обработки данных из формы**

1. Дополнить текущую реализацию обработки события UserCreatedEvent. Необходимо добавить в директорию Common интерфейс UserCreatedEventInterface
2. UserCreatedEvent заимплементировать от UserCreatedEventInterface тем самым сделав данное событие общим для всех модулей - каждый из модулей может подписаться на это событие, при этом UserCreatedEventInterface будет находится в общем ядре для модулей\
3. Создать объект Reader, сохранить в хранилище. При сохранении проверить необходимые инварианты




### Структуры модели Post <a name="post-structure"></a>

`Post`

| Название колонки  |     Тип      | nullable |           Назначение           |
|:-----------------:|:------------:|:--------:|:------------------------------:|
|        id         |     int      |   нет    |      Идентификатор поста       |
|       slug        | varchar(100) |   нет    |           slug поста           |
|       title       | varchar(255) |   нет    |           Заголовок            |
|    short_title    | varchar(100) |   нет    |       Короткий заголовок       |
|      content      |     text     |   нет    |       Содержание статьи        |
|     published     |   boolean    |   нет    |       Статус публикации        |
| comment_available |   boolean    |   нет    |    Доступность комментариев    |
|    category_id    |     UUID     |   нет    |        Категория поста         |
|   meta_keyword    | varchar(255) |    да    | Ключевые слова поста (для сео) |
| meta_description  | varchar(255) |    да    |    Описание поста (для сео)    |
|    created_at     |  timestampz  |   нет    |         Дата создания          |


`Image`

| Название колонки  |     Тип     | nullable |            Назначение             |
|:-----------------:|:-----------:|:--------:|:---------------------------------:|
|        id         |     int     |   нет    |       Идентификатор записи        |
|      post_id      |     int     |   нет    |  Идентификатор изображения поста  |
|    storage_id     |    UUID     |   нет    | Идентификатор файлового хранилища |
|       type        | varchar(50) |   нет    |  Тип изображения (main, content)  |




### Структуры модели Category <a name="post-category-structure"></a>

`Category`

| Название колонки  |     Тип      | nullable |           Назначение           |
|:-----------------:|:------------:|:--------:|:------------------------------:|
|        id         |     UUID     |   нет    |    Идентификатор категории     |
|       label       | varchar(50)  |   нет    |        Метка категории         |
|       name        | varchar(100) |   нет    |       Название категории       |
|    description    | varchar(255) |   нет    |       Описание категории       |
|    created_at     |  timestampz  |   нет    |         Дата создания          |




### Структуры модели Comment <a name="post-comment-structure"></a>

`Comment`

| Название колонки |      Тип      | nullable |            Назначение            |
|:----------------:|:-------------:|:--------:|:--------------------------------:|
|        id        |     UUID      |   нет    |    Идентификатор комментария     |
|    parent_id     |     UUID      |    да    |     Родительский комментарий     |
|     post_id      |      int      |   нет    |         Пост комментария         |
|     content      | varchar(1000) |   нет    |      Содержание комментария      |
|    author_id     |     UUID      |   нет    | Идентификатор автора комментария |
|    deleted_at    |  timestampz   |    да    |         Признак удаления         |
|    created_at    |  timestampz   |   нет    |          Дата создания           |




### Структуры модели Tag <a name="post-tag-structure"></a>

`Tag`

| Название колонки |     Тип      | nullable |     Назначение     |
|:----------------:|:------------:|:--------:|:------------------:|
|        id        |     int      |   нет    | Идентификатор тега |
|       name       | varchar(50)  |   нет    | Наименование тега  |
|   description    | varchar(255) |    да    |   Описание тега    |
|    deleted_at    |  timestampz  |    да    |  Признак удаления  |
|    created_at    |  timestampz  |   нет    |   Дата создания    |

`TagPostLink` (реализовать составной первичный ключ)

| Название колонки | Тип | nullable |     Назначение     |
|:----------------:|:---:|:--------:|:------------------:|
|      tag_id      | int |   нет    | Идентификатор тега |
|     post_id      | int |   нет    | Наименование поста |