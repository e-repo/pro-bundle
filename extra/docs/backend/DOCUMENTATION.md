# Содержание:

---
## Авторизация/Регистрация, модуль `Auth`

---

### Структуры:

---
- [Структура сущности User](#user-structure)

---
### Варианты использования:

---
- [Регистрация в админку c подтверждением email](#sign-up-to-admin)
- [Аутентификация в админку](#sign-in-to-admin)
- [Запрос на сброс пароля в админку](#access-recovery-to-admin)
- [Обновление пароля](#password-udate-to-admin)
- [Обновление email](#email-udate-to-admin)

<br>
<br>
<br>

### Структура сущности User <a name="user-structure"></a>

`User`

|    Название колонки    |     Тип      | nullable |             Назначение              |
|:----------------------:|:------------:|:--------:|:-----------------------------------:|
|           id           |     UUID     |   нет    |     Идентификатор пользователя      |
|       first_name       | varchar(255) |   нет    |                 Имя                 |
|       last_name        | varchar(255) |    да    |               Фамилия               |
|         email          | varchar(255) |   нет    |                Почта                |
|  email_confirm_token   | varchar(255) |    да    |   Подтвержение корректности email   |
|         status         | varchar(255) |   нет    |         Статус пользователя         |
|          role          | varchar(255) |   нет    |          Роль пользователя          |
|     password_hash      | varchar(255) |   нет    |             Хэш пароля              |
|          host          | varchar(100) |    да    |     Хост-источник пользователя      |
|  reset_password_token  | varchar(255) |    да    |         Токен сброса пароля         |
| password_token_expires |  timestamp   |    да    | Время действия токена сброса пароля |
|       new_email        | varchar(255) |    да    |             Новый email             |
|       created_at       |  timestamp   |   нет    |            Дата создания            |



### Регистрация в админку c подтверждением email <a name="sign-up-to-admin"></a>

**Бизнес смысл**

Регистрация представляет собой страницу sign page для входа в систему. Данная страница состоит из формы регистрации пользования со следующими полями: имя, email, пароль

**Входные данные**

| Название поля | Обязательность |             Примечание              |
|:-------------:|:--------------:|:-----------------------------------:|
|   firstName   |       да       | Валидация текста (min/max и прочее) |
|     email     |       да       |           Валидация email           |
|   password    |       да       |          Валидация пароля           |

**Логика обработки данных из формы**

1. Создать пользователя со статусом wait и с ролью ROLE_USER
2. Отправить пользователю на указанный email письмо с подтверждением аккаунта (email), где в качестве query string будет указан email_confirm_token и id пользователя. Ссылка подтверждения email пользователя формируется с учетом содержимого host в запросе от пользователя ($request->getHost()). Н-р - **https://<hostName>/confirm-email?userId=<id>&token=<token>**
3. При переходе по ссылке из письма статус пользователя меняет статус на active. Поле email_confirm_token обнуляется. С этого момента система считает пользователя авторизованным.
4. В очередь отправляется сообщение о добавлении пользователя (через event bus)

`*email_confirm_token - можно получить с использованием UUID`  
`*возможные статусы пользователя: blocked, active, wait`  
`*возможные роли пользователя: ROLE_USER, ROLE_ADMIN`  



### Аутентификация в админку<a name="sign-in-to-admin"></a>

**Бизнес смысл**

Представляет собой страницу для процедуры проверки подлинности пользователя

**Входные данные**

| Название поля | Обязательность |             Примечание              |
|:-------------:|:--------------:|:-----------------------------------:|
|     email     |       да       |           Валидация email           |
|   password    |       да       |          Валидация пароля           |

**Логика обработки данных из формы**

1. Настроить security bundle для входа пользователя в админку с сохранением ID сессии в cookie заголовках
2. После аутентификации пользователь должен попасть в админку сервиса



### Запрос на сброс пароля в админку<a name="access-recovery-to-admin"></a>

**Бизнес смысл**

Процесс обновления пароля в системе

**Входные данные**

| Название поля | Обязательность |             Примечание              |
|:-------------:|:--------------:|:-----------------------------------:|
|     email     |       да       |           Валидация email           |

**Логика обработки данных из формы**

1. Заполняем поля reset_password_token (UUID) и password_token_expires.
2. Отправляем пользователю письмо содержащее ссылку на страницу для сброса пароля. Ссылка содержит в query string reset_password_token который "разрешает" данному пользователю сбросить пароль



### Обновление пароля<a name="password-udate-to-admin"></a>

**Бизнес смысл**

Страница обновления пароля

**Входные данные**

|     Название поля      | Обязательность |    Примечание     |
|:----------------------:|:--------------:|:-----------------:|
|  reset_password_token  |       да       |  из query string  |
|        password        |       да       | Валидация пароля  |

**Логика обработки данных из формы**

1. Проверяем соответствует ли reset_password_token тому что в бд, если да переходим далее.
2. Проверяем поле password_token_expires, если password_token_expires < now(), то необходимо бросить исключение - "Срок действия токена для сброса пароля истек, повторите операцию". Обнуляем поля reset_password_token и password_token_expires
3. Обновляем пароль пользователя и через всплывашку указываем пользователю сообщение о том, что операция прошла успешно
4. Перенаправляем пользователя на страницу входа в систему



### Обновление email<a name="password-udate-to-admin"></a>

`*На данный момент это не является приоритетным функционалом, будет добавлен позднее`